<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Effect Research</title>
    <link rel="stylesheet" href="./main.css">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/3.10.1/mdb.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="assets/fonts/fontawesome5-overrides.min.css">
    <link rel="stylesheet" href="assets/css/Header-Blue.css">
    <link rel="stylesheet" href="assets/css/Hover-cards-1.css">
    <link rel="stylesheet" href="assets/css/Hover-cards.css">
    <link rel="stylesheet" href="assets/css/Soft-UI-Aside-Navbar.css">
    <link rel="stylesheet" href="assets/css/styles.css">
    <script src="https://unpkg.com/@effectai/effect-js/dist/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>

</head>

<body>
    <div class="container">
        <!-- <div class="card card1">
            <div class="card-body">
                <h3 class="card-title">Batch </h3>
                <p class="card-text small">You can check the results for the survay </p>
                <button class="btn">View Results</button>
                <div class="go-corner">
                    <div class="go-arrow"><div class="go-arrow">→</div></div>
                </div>
            </div>
        </div> -->
        <ul id="results" class="container"></ul>
       
        <aside id="sidenav-main" class="sidenav navbar navbar-vertical navbar-expand-xs border-0 border-radius-xl my-3 fixed-left ms-3">
            <div class="sidenav-header"><i class="fa fa-times p-3 cursor-pointer text-secondary opacity-5 position-absolute right-0 top-0 d-none d-xl-none"></i>
                <a class="navbar-brand m-0" href="">
                    <span class="ms-2 font-weight-bolder" style="font-size: 25px;">Effect Research<br></span>
                </a>
                <img src="assets/img/logonobg.png" alt="">
                <hr class="horizontal dark mt-0">
                <div id="sidenav-collapse-main" class="collapse navbar-collapse w-auto">
                    <ul class="navbar-nav">
                        <li class="nav-item"><a class="nav-link active" href=""><i class="fas fa-home active icon icon-shape icon-sm shadow border-radius-md text-center me-2 d-flex align-items-center justify-content-center"></i><span class="nav-link-text ms-1">Dashboard<br></span></a></li>
                        <br>
                        <li class="nav-item">
                            <button class="nav-link btn " data-mdb-toggle="modal" data-mdb-target="#exampleSideModal1"><i class="fa active fa-plus icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center"></i>
                                <span class="nav-link-text ms-1">Create New Survey<br></span>
                            </button>
                        </li>
                        <li class="nav-item mt-3"><span class="ps-4 ms-2 text-uppercase text-xs font-weight-bolder opacity-6">Account Details</span></li>
                        <li class="nav-item"><a class="nav-link" ><i class="fa fa-user icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center"></i>
                            <span class="nav-link-text ms-1">Profile<br></span></a>
                            <p class="nav-link" >Provider Name: Meta Mask</p>
                            <p class="nav-link" id='address' style="overflow: scroll;" ><span class="nav-link-text ms-1">Address:&nbsp;</span></p>
                            <p class="nav-link" id='accountName'style="overflow: scroll;"><span class="nav-link-text ms-1">accountName</span></p>
                        </li>
                    </ul>
                </div>
            </div>
        </aside>

        <!-- Modal -->
        <!-- Modal example - top right -->
        <div class="modal fade right" id="exampleSideModal1" tabindex="-1" aria-labelledby="exampleSideModal1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-side modal-top-right">
                <div class="modal-content">
                    <div class="modal-header">
                    <button
                        type="button"
                        class="btn-close"
                        data-mdb-dismiss="modal"
                        aria-label="Close"
                    ></button>
                    </div>
                    <div class="modal-body">

                        <div class="container" style="width: 100%; margin-left: 0px;">
                            <!-- code here -->
                            <div class="card">
                                <div class="card-image">	
                                    <h2 class="card-heading">
                                        Get started
                                        <small>Create a Research Survey</small>
                                    </h2>
                                </div>
                                <form class="card-form" onsubmit="event.preventDefault();addSurvay()">
                                    <div class="input">
                                        <input type="text" class="input-field" name="project_name" id="project_name" required/>
                                        <label class="input-label">Research Project Name:</label>
                                    </div>
                                    <div class="input">
                                            <input type="text" class="input-field" name="link" id='link' required/>
                                            <label class="input-label">Project Link:</label>
                                    </div>
                                    <div class="input">
                                        <input type="text" class="input-field" name="question1" id="question1" required/>
                                        <label class="input-label">Enter what question you want to ask:</label>
                                    </div>
                                    <div class="input">
                                        <input type="text" class="input-field" name="question2" id="question2"/>
                                        <label class="input-label">Enter If you have any other questions(optional):</label>
                                    </div>
                                    <div class="textarea">
                                        <textarea type="text" rows="5"  class="textarea-field" name="other_questions" placeholder="Other questions (separated by commas)(optional):" id="other_questions" ></textarea>
                                        
                                    </div>
                                    
                                    <div class="action">
                                        <button class="action-button">Submit</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        
                    </div>
                    
                </div>
            </div>
        </div>

        <!-- new modal -->

        <div id='modalsResult'></div>

    </div>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/3.10.1/mdb.min.js"></script>

    <script>
        let connectAccount = { providerName: undefined, provider: undefined, account: undefined };
        var address = document.getElementById('address');
        var accountName = document.getElementById('accountName');
        var results = document.getElementById('results');
        var modalsResult = document.getElementById('modalsResult');

        window.addEventListener('load', async function() {

            console.log('Creating SDK...')
            try {
                client = new effectsdk.EffectClient('jungle') //kylin
                console.log(client)
                console.log('SDK created successfully!')
                console.log('SDK Client: Connected')
            } catch (error) {
                console.error(error)
                alert('SDK Client: Error')   
            }
            if (!connectAccount.account){
                await connectMetamask();
            }
            batchs = await client.force.getCampaignBatches(197)
            console.log(batchs)
            if (batchs.length > 0) {
                batchs.map(async (batch) => {
                    console.log(batch)
                    result = await client.force.getTaskResult(batch.task_merkle_root)
                    if(result){
                        results.innerHTML += '<div class="card card1"> <div class="card-body"> <h3 class="card-title">Batch #'+result.batch_id+'</h3> <p class="card-text small">You can check the results for the survay </p> <button class="btn" data-mdb-toggle="modal" data-mdb-target="#resultModal'+result.batch_id+'" data-mdb-whatever="'+result.leaf_hash+'" >View Results</button> <div class="go-corner"> <div class="go-arrow"><div class="go-arrow">→</div></div> </div> </div> </div>'
                        resultData = ''
                        console.log(result.data)
                        const obj = JSON.parse(result.data)
                        console.log(obj)
                        Object.entries(obj).map(([key, value]) => {
                            resultData += '<p class="card-text">'+key+': '+value+'</p>'
                        })
                        // result.data.
                        modalsResult.innerHTML += '<div class="modal fade" id="resultModal'+result.batch_id+'" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="exampleModalLabel">Results</h5> <button type="button" class="btn-close" data-mdb-dismiss="modal" aria-label="Close" ></button> </div> <div class="modal-body"> '+ resultData +' </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-mdb-dismiss="modal"> Close </button> </div> </div> </div> </div>'
                    }
                    console.log(result)
                })
            } else {
                console.log('No Batchs')
            }
        });
    
        async function connectMetamask() {
            console.log('Connecting to metamask wallet.')
            if (window.ethereum) {
                try {
                    const ethAccount = await ethereum.request({ method: 'eth_requestAccounts' });
                    await ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: '0x38' }] // 0x38 is the chainId of bsc testnet.    
                    })

                    connectAccount.provider = new Web3(window.ethereum)
                    connectAccount.account = ethAccount[0]
                    connectAccount.providerName = 'metamask'
                    address.innerHTML = "Address: <br>"+connectAccount.account;
                    connectReponse = await client.connectAccount(connectAccount.provider, connectAccount.account)
                    console.log(connectReponse)
                    accountName.innerHTML = 'Account Name: <br>'+connectReponse.accountName;
                    
                   console.log(`Metmask Account: ${JSON.stringify(ethAccount, null, 2)}`)
                   console.log(`Connect with MetamaskAccount: ${ethAccount[0]}`)
                } catch (error) {
                    alert('Something went wrong. See console for error message')
                    window.location.href = 'index.html'
                    console.error(error)
                }
            } else {
                alert('Metamask not installed.')
            }
        }
        // create addSurvay function
        async function addSurvay() {
            console.log('Creating survey...')
            let project_name = document.getElementById('project_name').value;
            let link = document.getElementById('link').value;
            let question1 = document.getElementById('question1').value;
            let question2 = document.getElementById('question2').value;
            let other_questions = document.getElementById('other_questions').value;
            let survey = {
                project_name: project_name,
                link: link,
                question1: question1,
                question2: question2,
                other_questions: other_questions
            }
            console.log(survey)
            const content = {'tasks': [survey]}
            const campaign = await client.force.getCampaign(197)
            console.log("campaign", campaign)
            const batchResponse = await client.force.createBatch(campaign.id, content, 1)
            console.log("batchResponse", batchResponse)
            alert('Survey created successfully!')
            
            console.log('Waiting for results.........')
            waitForResult(batchResponse.leaves[0].substring(2))

        }

        async function waitForResult(leafHash){
            const result = await client.force.getTaskResult(leafHash)
            results.innerHTML += '<div class="card card1"> <div class="card-body"> <h3 class="card-title">Batch #'+result.batch_id+'</h3> <p class="card-text small">You can check the results for the survay </p> <button class="btn" data-mdb-toggle="modal" data-mdb-target="#resultModal'+result.batch_id+'" data-mdb-whatever="'+result.leaf_hash+'" >View Results</button> <div class="go-corner"> <div class="go-arrow"><div class="go-arrow">→</div></div> </div> </div> </div>'
            resultData = ''
            console.log(result.data)
            const obj = JSON.parse(result.data)
            console.log(obj)
            Object.entries(obj).map(([key, value]) => {
                resultData += '<p class="card-text">'+key+': '+value+'</p>'
            })
            // result.data.
            modalsResult.innerHTML += '<div class="modal fade" id="resultModal'+result.batch_id+'" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="exampleModalLabel">Results</h5> <button type="button" class="btn-close" data-mdb-dismiss="modal" aria-label="Close" ></button> </div> <div class="modal-body"> '+ resultData +' </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-mdb-dismiss="modal"> Close </button> </div> </div> </div> </div>'            
        }

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

</body>

</html>